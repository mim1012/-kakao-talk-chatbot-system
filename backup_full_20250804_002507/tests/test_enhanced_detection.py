#!/usr/bin/env python3
"""
ê°•í™”ëœ OCR ê°ì§€ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
ë‹¤ì–‘í•œ OCR ì˜¤ë¥˜ íŒ¨í„´ë“¤ì´ ì˜¬ë°”ë¥´ê²Œ "ë“¤ì–´ì™”ìŠµë‹ˆë‹¤"ë¡œ ì¸ì‹ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸
"""
from __future__ import annotations

import sys
import time
from enhanced_ocr_corrector import EnhancedOCRCorrector
from service_container import ServiceContainer

def test_ocr_patterns() -> bool:
    """OCR íŒ¨í„´ ì¸ì‹ í…ŒìŠ¤íŠ¸"""
    print("=" * 60)
    print("ğŸ§ª ê°•í™”ëœ OCR ê°ì§€ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸")
    print("=" * 60)
    
    # ê°•í™”ëœ ë³´ì •ê¸° ì´ˆê¸°í™”
    corrector = EnhancedOCRCorrector()
    
    # ì‹¤ì œ PaddleOCRì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ì˜¤ë¥˜ íŒ¨í„´ë“¤
    test_patterns = [
        # ì •í™•í•œ íŒ¨í„´ë“¤
        ("ë“¤ì–´ì™”ìŠµë‹ˆë‹¤", True, "ì •í™•í•œ í…ìŠ¤íŠ¸"),
        ("ì…ì¥í–ˆìŠµë‹ˆë‹¤", True, "ì •í™•í•œ í…ìŠ¤íŠ¸"), 
        ("ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤", True, "ì •í™•í•œ í…ìŠ¤íŠ¸"),
        
        # ì¼ë°˜ì ì¸ OCR ì˜¤ë¥˜ë“¤
        ("ë“¤ë¨¸ì™”ìŠµë‹ˆë‹¤", True, "ã…“->ã… ì˜¤ë¥˜"),
        ("ë‘˜ì–´ì™”ìŠµë‹ˆë‹¤", True, "ë“¤->ë‘˜ ì˜¤ë¥˜"),
        ("í‹€ì–´ì™”ìŠµë‹ˆë‹¤", True, "ë“¤->í‹€ ì˜¤ë¥˜"),
        ("ë“¤ì–´ì™”ì‹œë‹ˆë‹¤", True, "ìŠµ->ì‹œ ì˜¤ë¥˜"),
        ("ë“¤ì–´ì™”ëŠë‹ˆë‹¤", True, "ìŠµ->ëŠ ì˜¤ë¥˜"),
        ("ë“¤ì–´ì™”ìŠ´ë‹ˆë‹¤", True, "ìŠµ->ìŠ´ ì˜¤ë¥˜"),
        ("ë“¤ì–´ì™”ìë‹ˆë‹¤", True, "ìŠµ->ì ì˜¤ë¥˜"),
        ("ë“¤ì–´ì™”ã……ë‹ˆë‹¤", True, "ìŠµ->ã…… ì˜¤ë¥˜"),
        ("ë“¤ì–´ì™”5ë‹ˆë‹¤", True, "ìŠµ->5 ì˜¤ë¥˜"),
        ("ë“¤ì–´ì™”7ë‹ˆë‹¤", True, "ìŠµ->7 ì˜¤ë¥˜"),
        ("ë“¤ì–´ì™€ìŠµë‹ˆë‹¤", True, "ì™”->ì™€ ì˜¤ë¥˜"),
        ("ë“¤ì–´ì™”ìŠµë‹ˆíƒ€", True, "ë‹¤->íƒ€ ì˜¤ë¥˜"),
        ("ë“¤ì–´ì™”ìŠ¤ë‹ˆë‹¤", True, "ìŠµ->ìŠ¤ ì˜¤ë¥˜"),
        
        # ê³µë°±/íŠ¹ìˆ˜ë¬¸ì í¬í•¨
        ("ë“¤ì–´ì™”ìŠµë‹ˆë‹¤.", True, "ë§ˆì¹¨í‘œ í¬í•¨"),
        ("ë“¤ ì–´ ì™” ìŠµ ë‹ˆ ë‹¤", True, "ê³µë°± í¬í•¨"),
        ("ë“¤ì–´ì™”ìŠµë‹ˆë‹¤!!", True, "ëŠë‚Œí‘œ í¬í•¨"),
        (" ë“¤ì–´ì™”ìŠµë‹ˆë‹¤ ", True, "ì•ë’¤ ê³µë°±"),
        
        # ì…ì¥í–ˆìŠµë‹ˆë‹¤ ë³€í˜•ë“¤
        ("ì…ì •í–ˆìŠµë‹ˆë‹¤", True, "ì¥->ì • ì˜¤ë¥˜"),
        ("ì…ì°½í–ˆìŠµë‹ˆë‹¤", True, "ì¥->ì°½ ì˜¤ë¥˜"),
        ("ì…ì í–ˆìŠµë‹ˆë‹¤", True, "ì¥->ì  ì˜¤ë¥˜"),
        ("ì…ì¥í–¤ìŠµë‹ˆë‹¤", True, "í–ˆ->í–¤ ì˜¤ë¥˜"),
        ("ì…ì¥í–ˆìŠ¤ë‹ˆë‹¤", True, "ìŠµ->ìŠ¤ ì˜¤ë¥˜"),
        ("ì…ì¥í–ˆìŠ´ë‹ˆë‹¤", True, "ìŠµ->ìŠ´ ì˜¤ë¥˜"),
        
        # ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤ ë³€í˜•ë“¤
        ("ì°¸ì–´í–ˆìŠµë‹ˆë‹¤", True, "ì—¬->ì–´ ì˜¤ë¥˜"),
        ("ì°¸ì•¼í–ˆìŠµë‹ˆë‹¤", True, "ì—¬->ì•¼ ì˜¤ë¥˜"),
        ("ì ì—¬í–ˆìŠµë‹ˆë‹¤", True, "ì°¸->ì  ì˜¤ë¥˜"),
        ("ì°¸ì—¬í–¤ìŠµë‹ˆë‹¤", True, "í–ˆ->í–¤ ì˜¤ë¥˜"),
        ("ì°¸ì—¬í–ˆìŠ¤ë‹ˆë‹¤", True, "ìŠµ->ìŠ¤ ì˜¤ë¥˜"),
        
        # ë¶€ë¶„ ë§¤ì¹­ ì¼€ì´ìŠ¤
        ("ë“¤ì–´ì™”", True, "ì§§ì€ í˜•íƒœ"),
        ("ì…ì¥í–ˆ", True, "ì§§ì€ í˜•íƒœ"),
        ("ì°¸ì—¬í–ˆ", True, "ì§§ì€ í˜•íƒœ"),
        
        # ë§¤ì¹­ë˜ì§€ ì•Šì•„ì•¼ í•  ì¼€ì´ìŠ¤ë“¤
        ("ì•ˆë…•í•˜ì„¸ìš”", False, "ì¼ë°˜ ì¸ì‚¬"),
        ("ë°˜ê°‘ìŠµë‹ˆë‹¤", False, "ì¼ë°˜ ì¸ì‚¬"),
        ("ê°ì‚¬í•©ë‹ˆë‹¤", False, "ì¼ë°˜ ì¸ì‚¬"),
        ("ì¢‹ì€ í•˜ë£¨", False, "ì¼ë°˜ ë¬¸ì¥"),
        ("12345", False, "ìˆ«ìë§Œ"),
        ("", False, "ë¹ˆ ë¬¸ìì—´"),
        ("ã…‹ã…‹ã…‹", False, "ììŒë§Œ"),
        ("ë‚˜ê°”ìŠµë‹ˆë‹¤", False, "ë°˜ëŒ€ ì˜ë¯¸"),
        ("í‡´ì¥í–ˆìŠµë‹ˆë‹¤", False, "ë°˜ëŒ€ ì˜ë¯¸"),
        
        # Edge caseë“¤
        ("ë“¤ì–´ì™”ìŠµë‹ˆë‹¤ë“¤ì–´ì™”ìŠµë‹ˆë‹¤", True, "ì¤‘ë³µ"),
        ("abcë“¤ì–´ì™”ìŠµë‹ˆë‹¤xyz", True, "ì˜ë¬¸ ì„ì„"),
        ("123ë“¤ë¨¸ì™”ìŠµë‹ˆë‹¤456", True, "ìˆ«ì ì„ì„"),
    ]
    
    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    passed: int = 0
    failed: int = 0
    
    for i, (text, expected, description) in enumerate(test_patterns, 1):
        is_match, matched_pattern = corrector.check_trigger_pattern(text)
        
        # ê²°ê³¼ ê²€ì¦
        if is_match == expected:
            status = "âœ… PASS"
            passed += 1
        else:
            status = "âŒ FAIL"
            failed += 1
        
        # ê²°ê³¼ ì¶œë ¥
        result_info = f"-> {matched_pattern}" if is_match else "-> NO MATCH"
        print(f"{i:2d}. {status} | '{text}' {result_info}")
        print(f"     ì„¤ëª…: {description} | ì˜ˆìƒ: {'ë§¤ì¹­' if expected else 'ë¹„ë§¤ì¹­'}")
        
        if i % 10 == 0:  # 10ê°œë§ˆë‹¤ êµ¬ë¶„ì„ 
            print("-" * 60)
    
    # ìµœì¢… ê²°ê³¼
    total: int = len(test_patterns)
    success_rate: float = (passed / total) * 100
    
    print("=" * 60)
    print(f"ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼: {passed}/{total} í†µê³¼ ({success_rate:.1f}%)")
    
    if success_rate >= 95:
        print("ğŸ‰ ìš°ìˆ˜! OCR ë³´ì • ì‹œìŠ¤í…œì´ ë§¤ìš° ì˜ ì‘ë™í•©ë‹ˆë‹¤.")
    elif success_rate >= 85:
        print("ğŸ‘ ì–‘í˜¸! OCR ë³´ì • ì‹œìŠ¤í…œì´ ì˜ ì‘ë™í•©ë‹ˆë‹¤.")  
    elif success_rate >= 70:
        print("âš ï¸ ë³´í†µ! ì¼ë¶€ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.")
    else:
        print("âŒ ë¶ˆëŸ‰! OCR ë³´ì • ì‹œìŠ¤í…œì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.")
    
    if failed > 0:
        print(f"âš ï¸ {failed}ê°œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ì¶”ê°€ íŒ¨í„´ ë³´ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    
    return success_rate >= 85

def test_performance() -> bool:
    """ì„±ëŠ¥ í…ŒìŠ¤íŠ¸"""
    print("\n" + "=" * 60)
    print("âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸")
    print("=" * 60)
    
    corrector = EnhancedOCRCorrector()
    
    # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ìš© íŒ¨í„´ë“¤
    test_texts = [
        "ë“¤ì–´ì™”ìŠµë‹ˆë‹¤", "ë“¤ë¨¸ì™”ìŠµë‹ˆë‹¤", "ë‘˜ì–´ì™”ìŠµë‹ˆë‹¤", "í‹€ì–´ì™”ìŠµë‹ˆë‹¤",
        "ì…ì¥í–ˆìŠµë‹ˆë‹¤", "ì…ì •í–ˆìŠµë‹ˆë‹¤", "ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤", "ì°¸ì–´í–ˆìŠµë‹ˆë‹¤",
        "ì•ˆë…•í•˜ì„¸ìš”", "ë°˜ê°‘ìŠµë‹ˆë‹¤"
    ] * 10  # 10ë°° í™•ì¥
    
    # ì„±ëŠ¥ ì¸¡ì •
    start_time = time.time()
    
    for text in test_texts:
        corrector.check_trigger_pattern(text)
    
    end_time = time.time()
    
    # ê²°ê³¼ ê³„ì‚°
    total_time = end_time - start_time
    avg_time = (total_time / len(test_texts)) * 1000  # ms ë‹¨ìœ„
    throughput = len(test_texts) / total_time  # ì´ˆë‹¹ ì²˜ë¦¬ëŸ‰
    
    print(f"ğŸ“ˆ ì´ ì²˜ë¦¬ëŸ‰: {len(test_texts)}ê°œ í…ìŠ¤íŠ¸")
    print(f"ğŸ“ˆ ì´ ì‹œê°„: {total_time:.3f}ì´ˆ")
    print(f"ğŸ“ˆ í‰ê·  ì²˜ë¦¬ ì‹œê°„: {avg_time:.2f}ms/í…ìŠ¤íŠ¸")
    print(f"ğŸ“ˆ ì²˜ë¦¬ëŸ‰: {throughput:.1f}ê°œ/ì´ˆ")
    
    # ì‹¤ì‹œê°„ ì„±ëŠ¥ í‰ê°€
    if avg_time <= 1.0:
        print("ğŸš€ ìš°ìˆ˜í•œ ì„±ëŠ¥! ì‹¤ì‹œê°„ ì²˜ë¦¬ì— ì í•©í•©ë‹ˆë‹¤.")
    elif avg_time <= 5.0:
        print("ğŸ‘ ì–‘í˜¸í•œ ì„±ëŠ¥! ì‹¤ì‹œê°„ ì²˜ë¦¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
    elif avg_time <= 10.0:
        print("âš ï¸ ë³´í†µ ì„±ëŠ¥! ë°°ì¹˜ ì²˜ë¦¬ ê¶Œì¥í•©ë‹ˆë‹¤.")
    else:
        print("âŒ ëŠë¦° ì„±ëŠ¥! ìµœì í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
    
    return avg_time <= 5.0

def main() -> bool:
    """ë©”ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜"""
    print("ğŸ¯ ì¹´ì¹´ì˜¤í†¡ ì±—ë´‡ ê°•í™”ëœ OCR ê°ì§€ ì‹œìŠ¤í…œ ì¢…í•© í…ŒìŠ¤íŠ¸")
    print("ğŸ” ë‹¤ì–‘í•œ PaddleOCR ì˜¤ë¥˜ íŒ¨í„´ ì¸ì‹ ëŠ¥ë ¥ ê²€ì¦")
    print()
    
    # íŒ¨í„´ ì¸ì‹ í…ŒìŠ¤íŠ¸
    pattern_success = test_ocr_patterns()
    
    # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    performance_success = test_performance()
    
    # ìµœì¢… í‰ê°€
    print("\n" + "=" * 60)
    print("ğŸ† ìµœì¢… í‰ê°€")
    print("=" * 60)
    
    if pattern_success and performance_success:
        print("ğŸ‰ ì™„ë²½! ê°•í™”ëœ OCR ì‹œìŠ¤í…œì´ ì‹¤ì „ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.")
        print("âœ… 30ê°œ ì˜¤ë²„ë ˆì´ì—ì„œ ì‹¤ì‹œê°„ ê°ì§€ ì¤€ë¹„ ì™„ë£Œ!")
        return True
    elif pattern_success:
        print("ğŸ‘ íŒ¨í„´ ì¸ì‹ì€ ìš°ìˆ˜í•˜ë‚˜ ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
        return True
    elif performance_success:
        print("âš ï¸ ì„±ëŠ¥ì€ ì¢‹ìœ¼ë‚˜ íŒ¨í„´ ì¸ì‹ ì •í™•ë„ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        return False
    else:
        print("âŒ íŒ¨í„´ ì¸ì‹ê³¼ ì„±ëŠ¥ ëª¨ë‘ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)